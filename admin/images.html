<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片管理 - 夏雨店铺系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        /* ================== 全局样式 ================== */
        body { 
            background-color: #f4f7f6; 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        }
        
        /* 布局主容器 */
        .admin-container { 
            display: flex; 
            min-height: 100vh; 
            width: 100%; 
        }

        /* ================== 移动端专属顶栏 ================== */
        .admin-mobile-header {
            display: none; /* PC端隐藏 */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 50px;
            background-color: #ffffff;
            border-bottom: 1px solid #ddd;
            padding: 0 15px;
            z-index: 1001;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .admin-mobile-header .mobile-logo a {
            font-size: 18px; font-weight: bold; color: #333; text-decoration: none;
        }
        #mobile-menu-toggle {
            background: none; border: none; font-size: 20px; color: #555; padding: 5px;
        }

        /* ================== 遮罩层 ================== */
        .admin-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .admin-overlay.is-visible {
            display: block; opacity: 1;
        }
        
        /* ================== 左侧侧边栏 ================== */
        .admin-sidebar {
            width: 240px;
            background-color: #2c3e50;
            color: #ecf0f1;
            position: fixed;
            height: 100%;
            left: 0; top: 0;
            z-index: 100;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            padding: 20px; text-align: center; font-size: 20px; font-weight: bold;
            border-bottom: 1px solid #34495e; background-color: #2c3e50; flex-shrink: 0;
        }
        .sidebar-header a { color: #ecf0f1; text-decoration: none; }

        .sidebar-menu-container { flex: 1; overflow-y: auto; }
        .admin-sidebar ul { list-style: none; padding: 0; margin: 0; }
        .admin-sidebar ul li a {
            display: block; color: #bdc3c7; padding: 15px 20px;
            text-decoration: none; border-left: 3px solid transparent;
            transition: all 0.3s; font-size: 14px;
        }
        /* 鼠标悬停样式 */
        .admin-sidebar ul li a:hover { background-color: #34495e; color: #ffffff; }
        /* 选中高亮样式 */
        .admin-sidebar ul li a.active { background-color: #e74c3c; color: #ffffff; border-left-color: #c0392b; }
        .admin-sidebar ul li a i { margin-right: 10px; width: 20px; text-align: center; }

        .sidebar-footer {
            padding: 15px; text-align: center; font-size: 12px; color: #7f8c8d;
            border-top: 1px solid #34495e; background-color: #2c3e50; flex-shrink: 0;
        }

        /* ================== 内容区域 ================== */
        .admin-content { 
            margin-left: 240px; width: calc(100% - 240px); padding: 20px; 
            font-size: 14px; 
            transition: margin-left 0.3s;
        }
        .admin-content h3 { 
            font-size: 18px; font-weight: bold; margin-bottom: 20px; 
        }
        .logout-btn { color: #e74c3c !important; }

        /* ================== 图片管理页特有样式 ================== */
        .cat-item { cursor: pointer; padding: 10px; border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .cat-item:hover { background-color: #e9ecef; }
        .cat-item.active { background-color: #0d6efd; color: white; }
        
        .img-card { position: relative; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; background: #fff; transition: 0.2s; }
        .img-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .img-thumb { height: 120px; width: 100%; object-fit: contain; background-color: #eee; }
        .img-info { padding: 8px; font-size: 12px; }
        .img-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; font-weight: bold;}
        .img-actions { display: flex; justify-content: space-between; align-items: center; }
        
        .check-overlay { position: absolute; top: 5px; left: 5px; z-index: 10; transform: scale(1.2); }
        .copy-btn { cursor: pointer; color: #0d6efd; }

        /* ================== 响应式适配 ================== */
        @media (max-width: 800px) {
            /* 1. 显示移动端顶栏 */
            .admin-mobile-header { display: flex; }
            
            /* 2. 隐藏 PC 端侧边栏 (移出屏幕) */
            .admin-sidebar {
                left: -240px; 
                z-index: 1002;
            }
            
            /* 3. 滑出状态 */
            .admin-sidebar.is-visible { left: 0; }

            /* 4. 调整内容区域 */
            .admin-content {
                margin-left: 0; 
                width: 100%;
                padding-top: 70px; /* 留出顶栏高度 */
            }

            /* 图片管理页特定响应式调整 */
            .col-md-2 { margin-bottom: 15px; }
            .img-thumb { height: 100px; }
        }
    </style>
</head>
<body>

<script src="../config.js"></script>

<div class="admin-mobile-header">
    <div class="mobile-logo">
        <a href="#">夏雨店铺系统</a>
    </div>
    <button id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>
</div>

<div class="admin-overlay"></div>

<div class="admin-container">
    <div class="admin-sidebar" id="sidebar">
        <div class="sidebar-header"><a href="/admin/dashboard.html">XYRJ Faka</a></div>
        <div class="sidebar-menu-container">
            <ul>
                <li><a href="/admin/dashboard.html"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="/admin/categories.html"><i class="fas fa-folder"></i> 商品分类</a></li>
                <li><a href="/admin/products.html"><i class="fas fa-box"></i> 商品管理</a></li>
                <li><a href="/admin/cards.html"><i class="fas fa-ticket-alt"></i> 卡密管理</a></li>
                <li><a href="/admin/orders.html"><i class="fas fa-shopping-cart"></i> 订单管理</a></li>
                <li><a href="/admin/payments.html"><i class="fas fa-credit-card"></i> 支付设置</a></li>
                <li><a href="/admin/article_categories.html"><i class="fas fa-tags"></i> 文章分类</a></li>
                <li><a href="/admin/articles.html"><i class="fas fa-newspaper"></i> 文章管理</a></li>
                <li><a href="/admin/settings.html"><i class="fas fa-cog"></i> 系统设置</a></li>
                <li><a href="/admin/images.html" class="active"><i class="fas fa-images"></i> 图片管理</a></li> 
                <li><a href="javascript:logout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> 退出登录</a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            夏雨店铺系统 Version <span id="app-version">...</span>
        </div>
    </div>

    <div class="admin-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-images"></i> 图片资源库</h3>
            <div>
                <button class="btn btn-outline-secondary btn-sm me-2" onclick="scanImages()"><i class="fas fa-sync"></i> 扫描全站已有图片</button>
                <button class="btn btn-danger btn-sm me-2" onclick="batchDelete()" id="btn-del" style="display:none;"><i class="fas fa-trash"></i> 删除选中 (<span id="sel-count">0</span>)</button>
                <button class="btn btn-success btn-sm me-2" onclick="uploadToGithub()"><i class="fas fa-cloud-upload-alt"></i> 上传文件</button>
                <button class="btn btn-primary btn-sm" onclick="showAddModal()"><i class="fas fa-link"></i> 添加链接</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-2">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <span class="small fw-bold">分类</span>
                        <button class="btn btn-xs btn-link p-0" onclick="addCategory()"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="card-body p-2" id="cat-list">
                        </div>
                </div>
            </div>

            <div class="col-md-10">
                <div class="row g-3" id="img-list">
                    </div>
                <nav class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加图片链接</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">图片分类</label>
                    <select class="form-select" id="add-cat-id"></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">图片链接 (一行一个，支持批量粘贴)</label>
                    <textarea class="form-control" id="add-urls" rows="6" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.png"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveImages()">保存</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑图片信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="mb-3">
                    <label class="form-label">图片名称</label>
                    <input type="text" class="form-control" id="edit-name">
                </div>
                <div class="mb-3">
                    <label class="form-label">移动到分类</label>
                    <select class="form-select" id="edit-cat-id"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitEdit()">保存修改</button>
            </div>
        </div>
    </div>
</div>
    
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
<script>
    const TOKEN = localStorage.getItem('ADMIN_TOKEN');
    if(!TOKEN) window.location.href = '/admin/index.html';
    
    // 版本号显示
    if (window.SITE_CONFIG && window.SITE_CONFIG.version) {
        document.getElementById('app-version').innerText = window.SITE_CONFIG.version;
    } else {
        document.getElementById('app-version').innerText = '1.0.0';
    }

    function logout() { 
        if(confirm('确定要退出登录吗？')) {
            localStorage.removeItem('ADMIN_TOKEN'); 
            window.location.href = '/admin/index.html'; 
        }
    }

    async function api(path, method = 'GET', body = null) {
        const opts = { headers: { 'Authorization': `Bearer ${TOKEN}` } };
        if(method === 'POST') {
            opts.method = 'POST';
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify(body);
        }
        try {
            const res = await fetch('/api/admin/' + path, opts);
            if(res.status === 401) { logout(); return null; }
            return res.json();
        } catch(e) { alert('API Error'); return null; }
    }

    let currentCat = 'all';
    let currentPage = 1;
    let categories = [];
    let selectedIds = new Set();

    // 1. 加载分类
    async function loadCategories() {
        const res = await api('image/categories');
        if(res) {
            categories = res;
            renderCategories();
        }
    }

    function renderCategories() {
        const html = `
            <div class="cat-item ${currentCat === 'all' ? 'active' : ''}" onclick="switchCat('all')">
                <span>全部图片</span>
            </div>
        ` + categories.map(c => `
            <div class="cat-item ${currentCat == c.id ? 'active' : ''}" onclick="switchCat(${c.id})">
                <span>${c.name}</span>
                ${c.id != 1 ? `<i class="fas fa-times text-danger ms-2" onclick="event.stopPropagation(); deleteCategory(${c.id})"></i>` : ''}
            </div>
        `).join('');
        document.getElementById('cat-list').innerHTML = html;
        
        // 填充模态框下拉
        const select = document.getElementById('add-cat-id');
        select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    // 2. 加载图片
    async function loadImages(page = 1) {
        currentPage = page;
        selectedIds.clear();
        updateBtnState();

        let path = `images/list?page=${page}`;
        if(currentCat !== 'all') path += `&category_id=${currentCat}`;
        
        const res = await api(path);
        if(res && res.data) {
            renderImages(res.data);
            renderPagination(res.total, res.limit, res.page);
        }
    }

    function renderImages(list) {
        const container = document.getElementById('img-list');
        if(list.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted py-5">暂无图片，请点击右上角添加或扫描</div>';
            return;
        }
        
        container.innerHTML = list.map(img => `
            <div class="col-6 col-md-4 col-lg-3 col-xl-2">
                <div class="img-card">
                    <input type="checkbox" class="form-check-input check-overlay" value="${img.id}" onchange="toggleSelect(this)">
                    <a href="${img.url}" target="_blank">
                        <img src="${img.url}" class="img-thumb" loading="lazy">
                    </a>
                    <div class="img-info">
                        <div class="img-name" title="${img.name}">${img.name}</div>
                        <div class="img-actions">
                            <i class="fas fa-copy copy-btn" onclick="copyUrl('${img.url}', this)" title="复制链接"></i>
                            <i class="fas fa-edit text-primary mx-2" style="cursor:pointer" onclick="openEditModal(${img.id}, '${img.name.replace(/'/g, "\\'")}', ${img.category_id})" title="修改/移动"></i>
                            <i class="fas fa-trash text-danger" style="cursor:pointer" onclick="deleteSingle(${img.id})" title="删除"></i>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // 3. 交互功能
    function switchCat(id) {
        currentCat = id;
        renderCategories();
        loadImages(1);
    }

    async function addCategory() {
        const name = prompt('请输入新分类名称：');
        if(name) {
            await api('image/category/save', 'POST', { name, sort: 0 });
            loadCategories();
        }
    }

    async function deleteCategory(id) {
        if(confirm('确定删除该分类吗？该分类下的图片将移至默认分类。')) {
            await api('image/category/delete', 'POST', { id });
            loadCategories();
        }
    }

    // 添加图片
    const addModal = new bootstrap.Modal(document.getElementById('addModal'));
    function showAddModal() { addModal.show(); }
    
    // [新增] 简单的单张图片上传 (上传到 GitHub 并自动刷新列表)
    async function uploadToGithub() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
        input.onchange = async e => {
            if(!e.target.files[0]) return;
            const formData = new FormData(); formData.append('file', e.target.files[0]);
            
            const btn = document.querySelector('.btn-primary'); // 获取添加按钮临时变态
            const oldText = btn.innerHTML; btn.innerHTML = '上传中...'; btn.disabled = true;
            
            try {
                const res = await fetch('/api/admin/gh/upload', { method: 'POST', headers: { 'Authorization': `Bearer ${TOKEN}` }, body: formData }).then(r=>r.json());
                if(res.location) {
                    alert('上传成功'); loadImages(1);
                } else {
                    alert(res.error || '上传失败，请检查系统设置中的 GitHub 配置');
                }
            } catch(e) { alert('上传错误'); } 
            finally { btn.innerHTML = oldText; btn.disabled = false; }
        };
        input.click();
    }

    async function saveImages() {
        const urls = document.getElementById('add-urls').value;
        const catId = document.getElementById('add-cat-id').value;
        if(!urls) return alert('请输入链接');
        
        const res = await api('image/save', 'POST', { urls, category_id: catId });
        if(res && res.success) {
            addModal.hide();
            document.getElementById('add-urls').value = '';
            loadImages(1);
            alert(`成功添加 ${res.count} 张图片`);
        }
    }

    // 扫描全站
    async function scanImages() {
        if(!confirm('这将扫描商品、文章和系统设置中的所有图片链接并导入到“默认分类”，可能需要几秒钟，确定继续吗？')) return;
        const res = await api('images/scan', 'POST', {});
        if(res) {
            alert(`扫描完成，新增导入 ${res.count} 张图片`);
            loadImages(1);
        }
    }

    // 选择与批量删除
    function toggleSelect(el) {
        const id = parseInt(el.value);
        if(el.checked) selectedIds.add(id); else selectedIds.delete(id);
        updateBtnState();
    }
    
    function updateBtnState() {
        const btn = document.getElementById('btn-del');
        document.getElementById('sel-count').innerText = selectedIds.size;
        btn.style.display = selectedIds.size > 0 ? 'inline-block' : 'none';
    }

    async function batchDelete() {
        if(!confirm(`确定删除选中的 ${selectedIds.size} 张图片吗？`)) return;
        const ids = Array.from(selectedIds);
        const res = await api('image/delete', 'POST', { ids });
        if(res.success) loadImages(currentPage);
    }

    async function deleteSingle(id) {
        if(!confirm('确定删除此图片？')) return;
        await api('image/delete', 'POST', { ids: [id] });
        loadImages(currentPage);
    }

    function copyUrl(url, el) {
        navigator.clipboard.writeText(url).then(() => {
            const originalClass = el.className;
            el.className = 'fas fa-check text-success'; 
    
            const tip = document.createElement('span');
            tip.innerText = '已复制';
            Object.assign(tip.style, {
                position: 'absolute', backgroundColor: 'rgba(0,0,0,0.8)', color: '#fff', padding: '2px 6px',
                borderRadius: '4px', fontSize: '12px', bottom: '100%', left: '50%', transform: 'translateX(-50%)',
                whiteSpace: 'nowrap', pointerEvents: 'none', zIndex: '1000'
            });
    
            if (getComputedStyle(el.parentElement).position === 'static') {
                el.parentElement.style.position = 'relative';
            }
            el.parentElement.appendChild(tip);
    
            setTimeout(() => {
                el.className = originalClass; 
                if(tip.parentNode) tip.parentNode.removeChild(tip);
            }, 1000);
        });
    }

    // 分页渲染
    function renderPagination(total, limit, page) {
        const totalPages = Math.ceil(total / limit);
        if(totalPages <= 1) {
            document.getElementById('pagination').innerHTML = '';
            return;
        }
        let html = '';
        for(let i=1; i<=totalPages; i++) {
            html += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="javascript:loadImages(${i})">${i}</a></li>`;
        }
        document.getElementById('pagination').innerHTML = html;
    }
    
    // --- 编辑功能 ---
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openEditModal(id, name, catId) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-name').value = name;
        
        const select = document.getElementById('edit-cat-id');
        select.innerHTML = categories.map(c => 
            `<option value="${c.id}" ${c.id == catId ? 'selected' : ''}>${c.name}</option>`
        ).join('');
        
        editModal.show();
    }

    async function submitEdit() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('edit-name').value;
        const catId = document.getElementById('edit-cat-id').value;
        
        if(!name) return alert('名称不能为空');

        const res = await api('image/update', 'POST', { id, name, category_id: catId });
        if(res && res.success) {
            editModal.hide();
            loadImages(currentPage); 
        }
    }
    
    // 初始化
    loadCategories();
    loadImages();

    // --- 移动端菜单逻辑 (MyBlog风格) ---
    const mobileBtn = document.getElementById('mobile-menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.admin-overlay');
    const icon = mobileBtn.querySelector('i');

    function toggleMenu() {
        sidebar.classList.toggle('is-visible');
        overlay.classList.toggle('is-visible');
        
        if (icon.classList.contains('fa-bars')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
        } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        }
    }

    mobileBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleMenu();
    });

    overlay.addEventListener('click', function() {
        toggleMenu();
    });

    // 点击菜单项后自动关闭
    const menuLinks = document.querySelectorAll('.admin-sidebar a');
    menuLinks.forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 800 && sidebar.classList.contains('is-visible')) {
                toggleMenu();
            }
        });
    });
</script>
</body>
</html>
